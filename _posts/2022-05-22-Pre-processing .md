---
title: 星空摄影深空图像的预处理与降噪
tags: [星空摄影, 图像处理, 降噪方法]
style: fill
color: primary
comments: true
description: 天文摄影中，很重要的一个词就是信噪比，即信号与噪声的比值。在日常摄影中，相机接收到的光信号是远大于噪声的，我们可以将噪声忽略，但是在天文摄影中，我们拍摄的目标是宇宙中非常暗弱的天体，其光信号可能并不比噪声强多少，此时我们就需要在处理深空图像前，先对其进行预处理，而预处理中很重要的一步就是图像校准。
---

天文摄影中，很重要的一个词就是信噪比，即信号与噪声的比值。在日常摄影中，相机接收到的光信号是远大于噪声的，我们可以将噪声忽略，但是在天文摄影中，我们拍摄的目标是宇宙中非常暗弱的天体，其光信号可能并不比噪声强多少，此时我们就需要在处理深空图像前，先对其进行预处理，而预处理中很重要的一步就是图像校准。

<h3><i><font>一、噪声</font></i></h3>
在讲图像校准之前，我们需要先了解噪声的来源。天文摄影中的噪声可以这样分类：
<img src="../assets/2022-5-22——img/1.jpg">
首先解释一下固定噪声和随机噪声。固定噪声即在拍摄的每张图像上的分布基本一致的噪声，随机噪声则是在每张图像上都随机分布的噪声。由于这两种噪声的特性，我们在校准过程中即可减去固定噪声，而随机噪声则需要对图像进行叠加来削弱。  

## 接下来介绍一下各种噪声的来源和特点：
  
* <b>零曝光噪声：</b>相机在无光子进入，且曝光时间为0（非常短）时，相机所拍摄的图像并不是全黑（即无任何信号）的，而是呈现出一种特殊的偏置图案，这就是零曝光噪声。下面两张图中，左图为FLIProline16803相机的偏置图案，右图为QHYminicam5相机的偏置图案（均经过拉伸）
<img src="../assets/2022-5-22——img/2.jpg">
* <b>热噪声：</b>这种噪声比较特殊，是由电子的无规则热运动生成的热电荷引起的，热电荷的生成速率被称之为暗电流。它随着曝光时间的增长而增加，增加速率与温度有关，温度越高，增加越快，且不同像素的暗电流增加速率也不同。
<img src="../assets/2022-5-22——img/3.jpg">
* <b>光噪声：</b>由于拍摄的深空天体一般都比较暗弱，传感器接收到的光子数较少，由于光子的量子特性，此时光子的涨落就会很明显。也就是说，对于一个像素，假设它接收到的光子的均值是100（光源亮度稳定），但是在不同的帧中，其接收到的光子则是100附近的值，其分布服从泊松分布。

<h3><i><font>二、校准帧</font></i></h3>
为了削弱噪声，我们需要拍摄一系列的校准帧。  
天文摄影中常见的校准帧有三种：偏置场、暗场和平场。其中，偏置场和暗场可以用来去除零曝光噪声和热噪声，平场则是为了消除光学系统的减光。此外，我们拍摄的含有天体信息的图像叫做亮场。下面我们先说明一下三种帧的拍摄方法：  


* <b>偏置场（Bias）：</b>  偏置场的拍摄需要盖上望远镜的镜头盖，使光线不能进入传感器，然后将相机的曝光时间设为最短，进行拍摄。
* <b>暗场（Dark）：</b>    暗场的拍摄同样不允许光线进入传感器，然后将相机的曝光时间设为与亮场单张曝光时间相等（实际上也可以不相等，参见下文），进行拍摄。注意，拍摄暗场时相机的温度需要与实际拍摄时的相等，不然会导致拍摄的暗场不准确，这也是制冷相机相较于单反的优点，即制冷相机可以使拍摄时的温度保持恒定，获得准确的暗场。  
* <b>平场（Flat）：</b>  将望远镜指向均匀发光的光源，如黎明或黄昏时的天顶附近，打开镜头盖进行拍摄，拍摄时注意不要欠曝或过曝，一般来说以直方图的顶端位于整个直方图的2/3处为宜。由于此时仍有可能拍摄到一些亮星，故在拍摄时每两张之间应使望远镜略微移动一些距离，这样在叠加时可通过SigmaClip即可去除亮星的影响。另外，也可以购买平场板来拍摄平场。  
<br>
下图即为各个校准帧中包含的信息，从内到外分别为偏置场，暗场和平场。
<img src="../assets/2022-5-22——img/4.jpg">
注意，所有的图像都包含有读出噪声。为了削弱读出噪声的影响，我们拍摄的所有校准帧都应拍摄多张，进行叠加（即取平均值）。读出噪声虽然属于随机噪声，但是它服从正态分布。这样，我们就可以通过拍摄多张叠加的方法来削弱读出噪声，得到真实值。
<br>
这样一来，深空图像的校准流程思路就很清晰了。
<h3><i><font>三、深空图像校准的基本思路</font></i></h3>
首先，我们拍摄多张偏置场进行叠加，生成一张总偏置场（MasterBias），那么这张总偏置场上就含有了该相机的零曝光噪声。只要将拍摄的图像减去总偏置场，我们就去除了零曝光噪声。由于拍摄偏置比较方便，且不需要太长时间，拍摄的张数应该尽量多，几十张为宜。偏置和读出噪声一样，每张图像都会含有，但是只要我们拍摄好偏置场，就可以很轻松地去除偏置。  


接下来，我们拍摄多张暗场进行叠加，生成一张叠加后的暗场。注意，这张叠加后的暗场除了我们想要的每个像素的暗电流之外，还含有偏置。因此，我们需要将叠加后的暗场减去总偏置，这样我们就得到了总暗场（MasterDark）。假设该每帧暗场的曝光时间为a分钟，拍摄时的温度为t℃，那么，我们就可以根据总暗场得出所有像素在t℃下a分钟积累的暗电流大小。只要将拍摄的图像减去总暗场，我们就去除了暗电流。前面我们提到，暗场的曝光时间可以与亮场的单张曝光时间不同。如果亮场的单张曝光时间为b，由于暗电流的积累速度与时间成正比，那么我们只需要将减去偏置的总暗场乘以b/a，我们就可以得到所有像素b分钟积累的暗电流大小。做减法之后，我们同样也可以去除暗电流。  
最后，我们要生成总平场（MasterFlat）。在这之前，我们先谈一谈为什么需要平场。由于望远镜的光学结构和望远镜、滤镜或相机传感器上的灰尘的影响，如果我们将望远镜对着均匀发光源拍摄一张曝光合适的图像，我们得到的图像并不是亮度均匀的（忽略各种噪声），而是会受到暗角（如下左图）和灰尘（如下右图）的影响。
<img src="../assets/2022-5-22——img/5.jpg">
假设理论上我们拍摄的图像上每个像素的亮度均应为100，但由于暗角的影响，左上角某一点像素的亮度只有70，那么这个像素的减光比就是0.7。这个减光比在拍摄天体时同样存在，且只要光学系统或灰尘的位置不发生变化，该像素减光比就不会变化。那么我们只需要将减过偏置和暗场的深空图像除以这个减光比，就可以消除光学系统的减光。
<img src="../assets/2022-5-22——img/6.jpg">
上面的左图是减过偏置和暗场但未除平场的M16星云，右图则是减过偏置和暗场且除过平场的M16星云，可以很明显地看到暗角被消除了。
<br>
<br>
那么，怎么生成总平场呢？我们拍摄的单帧平场中含有偏置图像、暗电流、读出噪声、光噪声，和我们想要的减光比，所以我们需要减去偏置和暗场，再通过叠加来削弱读出噪声和光噪声，但有几点需要注意。由于平场的曝光时间一般都在几秒左右，暗电流累积的很少，所以我们可以只减偏置，不减暗场。另外，由于平场叠加时需要进行归一化（Normalization），我们需要在叠加前先将所有单帧都减去总偏置，再进行叠加。叠加之后，我们就得到了总平场（MasterFlat）。